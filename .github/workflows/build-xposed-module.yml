name: Build S789 Xposed Module

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - '.github/workflows/build-xposed-module.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create module project
        run: |
          mkdir -p app/src/main/java/com/s789/xposed
          mkdir -p app/src/main/assets
          mkdir -p app/src/main/res/values
          
          cat > app/src/main/java/com/s789/xposed/MainHook.java << 'JAVA'
          package com.s789.xposed;
          import de.robv.android.xposed.IXposedHookLoadPackage;
          import de.robv.android.xposed.XC_MethodHook;
          import de.robv.android.xposed.XposedBridge;
          import de.robv.android.xposed.XposedHelpers;
          import de.robv.android.xposed.callbacks.XC_LoadPackage;
          public class MainHook implements IXposedHookLoadPackage {
              @Override
              public void handleLoadPackage(XC_LoadPackage.LoadPackageParam lpparam) throws Throwable {
                  if (!lpparam.packageName.equals("com.sukisu.ultra")) return;
                  XposedBridge.log("S789: Hooking SukiSU");
                  XposedHelpers.findAndHookMethod(
                      android.content.SharedPreferences.class,
                      "getBoolean", String.class, boolean.class,
                      new XC_MethodHook() {
                          @Override
                          protected void afterHookedMethod(MethodHookParam param) {
                              if ("is_simple_mode".equals(param.args[0])) {
                                  param.setResult(true);
                              }
                          }
                      }
                  );
              }
          }
          JAVA

          echo "com.s789.xposed.MainHook" > app/src/main/assets/xposed_init

          cat > app/src/main/AndroidManifest.xml << 'XML'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.s789.xposed">
              <application android:label="S789 UI Mod">
                  <meta-data android:name="xposedmodule" android:value="true"/>
                  <meta-data android:name="xposeddescription" android:value="SukiSU: Simple mode ON"/>
                  <meta-data android:name="xposedminversion" android:value="93"/>
                  <meta-data android:name="xposedscope" android:resource="@array/xposed_scope"/>
              </application>
          </manifest>
          XML

          cat > app/src/main/res/values/arrays.xml << 'XML'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string-array name="xposed_scope">
                  <item>com.sukisu.ultra</item>
              </string-array>
          </resources>
          XML

          cat > app/build.gradle << 'GRADLE'
          plugins { id 'com.android.application' }
          android {
              namespace 'com.s789.xposed'
              compileSdk 34
              defaultConfig {
                  applicationId "com.s789.xposed"
                  minSdk 26
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }
          dependencies { compileOnly 'de.robv.android.xposed:api:82' }
          GRADLE

          cat > build.gradle << 'GRADLE'
          plugins { id 'com.android.application' version '8.1.0' apply false }
          GRADLE

          cat > settings.gradle << 'GRADLE'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
                  maven { url 'https://api.xposed.info/' }
              }
          }
          rootProject.name = "S789Xposed"
          include ':app'
          GRADLE

          echo "android.useAndroidX=true" > gradle.properties

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build
        run: ./gradlew :app:assembleDebug --no-daemon --stacktrace

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: S789-Xposed-Module
          path: app/build/outputs/apk/debug/*.apk
